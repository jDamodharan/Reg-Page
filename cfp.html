<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFP - ExploitX Meetup 2026</title>

    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>

<body>

<header>
    <a href="index.html">‚Üê Back to Event</a>
    <h1>Call for Proposals</h1>
    <p>ExploitX Cybersecurity & Networking Meetup 2026</p>
</header>

<main>
    <form id="cfpForm">

        <h2>Proposal Details</h2>

        <label>Proposal Title *</label>
        <input type="text" id="proposal-title" required>

        <label>Proposal Description *</label>
        <div id="editor-description"></div>
        <input type="hidden" id="proposal-description">

        <label>Proposal Takeaways *</label>
        <div id="editor-takeaways"></div>
        <input type="hidden" id="proposal-takeaways">

        <label>Session Type *</label>
        <select id="session-type" required>
            <option value="">Select session type</option>
            <option value="lightning-talk">Lightning Talk</option>
            <option value="talk">Full Talk</option>
            <option value="workshop">Workshop</option>
        </select>

        <label>Is this your first talk? *</label>
        <select id="first-talk" required>
            <option value="">Select</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
        </select>

        <h2>Personal Information</h2>

        <label>Full Name *</label>
        <input type="text" id="fullname" required>

        <label>Occupation</label>
        <input type="text" id="occupation">

        <label>Organization</label>
        <input type="text" id="organization">

        <label>Email *</label>
        <input type="email" id="email" required>

        <button type="submit">Submit Proposal</button>
    </form>
</main>

<footer>
    <p>Contact: exploitx@citchennai.net</p>
    <p>&copy; 2026 ExploitX Meetup</p>
</footer>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
/* ---------- QUILL TOOLBAR ---------- */
const fullToolbar = [
    [{ 'header': [1, 2, 3, false] }],
    ['bold', 'italic', 'underline', 'strike'],
    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
    ['blockquote', 'code-block'],
    ['link'],
    [{ 'align': [] }],
    ['clean']
];

/* ---------- INIT QUILL ---------- */
let quillDescription, quillTakeaways;

window.addEventListener("DOMContentLoaded", () => {
    quillDescription = new Quill('#editor-description', {
        theme: 'snow',
        modules: { toolbar: fullToolbar }
    });

    quillTakeaways = new Quill('#editor-takeaways', {
        theme: 'snow',
        modules: { toolbar: fullToolbar }
    });
});

/* ---------- SYNC QUILL TO HIDDEN INPUT ---------- */
function syncQuill() {
    document.getElementById("proposal-description").value =
        quillDescription.root.innerHTML;

    document.getElementById("proposal-takeaways").value =
        quillTakeaways.root.innerHTML;
}

/* ---------- LOAD EMAILJS CONFIG ---------- */
let config = null;

fetch("/api/config")
    .then(res => res.json())
    .then(data => {
        config = data;
        emailjs.init(config.publicKey);
        console.log("EmailJS Config Loaded");
    })
    .catch(err => console.error("Failed to load config:", err));

/* ---------- FORM SUBMIT ---------- */
document.getElementById("cfpForm").addEventListener("submit", async (event) => {
    event.preventDefault();
    syncQuill();

    if (!config) {
        alert("Configuration not loaded.");
        return;
    }

    const formData = {
        proposal_title: document.getElementById("proposal-title").value,
        proposal_description: document.getElementById("proposal-description").value,
        proposal_takeaways: document.getElementById("proposal-takeaways").value,
        session_type: document.getElementById("session-type").value,
        first_talk: document.getElementById("first-talk").value,
        fullname: document.getElementById("fullname").value,
        occupation: document.getElementById("occupation").value,
        organization: document.getElementById("organization").value,
        email: document.getElementById("email").value
    };

    try {
        // Send owner mail (once)
        await emailjs.send(config.serviceId, config.templateOwner, formData);

        // Send auto reply (once)
        await emailjs.send(config.serviceId, config.templateAutoReply, formData);

        // Success popup
        alert("Your proposal has been submitted successfully!");

        // Wait 2 seconds then go home
        setTimeout(() => {
            window.location.href = "index.html";
        }, 2000);

    } catch (err) {
        console.error("EmailJS Error:", err);
        alert("Submission failed. Try again.");
    }
});
</script>

</body>
</html>
